<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Official Receipt - {{ transaction.receipt_number }}</title>
    <style>
        /* Color Palette (Primary: #667eea, Success: #059669, Warning: #d97706) */

        @page {
            size: A4;
            margin: 1.5cm;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.4;
            color: #111827; 
        }
        
        /* --- Header Section (Two-Column Table Layout) --- */
        .header-top {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
        }
        .logo-section {
            width: 60%;
            vertical-align: top;
            padding: 0;
        }
        .meta-section {
            width: 40%;
            vertical-align: top;
            padding: 0;
            text-align: right;
        }
        .clinic-logo-text {
            font-size: 20pt;
            font-weight: 800;
            color: #111827; 
            margin: 0;
            line-height: 1.1;
        }
        .clinic-tagline {
            font-size: 9pt;
            color: #6b7280; 
            margin: 2px 0 16px 0;
        }
        .bill-to {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: left;
            margin-top: 8px;
            display: inline-block;
            width: 100%;
        }
        .bill-to .label {
            font-size: 8pt;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .receipt-title {
            font-size: 22pt;
            font-weight: 700;
            color: #667eea;
            margin: 0;
            padding: 0;
        }
        .receipt-meta-item {
            font-size: 10pt;
            margin: 4px 0;
        }
        .receipt-meta-item strong {
            font-weight: 700;
            color: #111827;
            width: 120px;
            display: inline-block;
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 9pt;
            font-weight: 600;
            margin-top: 8px;
        }
        .status-paid { background: #d1fae5; color: #065f46; }
        .status-partial { background: #fef3c7; color: #d97706; }

        /* --- Items Table (Unified Style) --- */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border: 1px solid #e5e7eb;
        }
        .items-table th {
            background-color: #667eea; /* Primary blue header */
            color: white;
            padding: 10px 12px;
            text-align: left;
            font-size: 10pt;
            font-weight: 600;
            border: none;
        }
        .items-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 10pt;
            vertical-align: top;
        }
        .items-table tr:last-child td {
            border-bottom: none;
        }
        .product-list {
            font-size: 9pt;
            color: #4b5563;
            list-style: none;
            padding-left: 0;
            margin: 4px 0 0 0;
        }
        .product-list li {
            margin-bottom: 2px;
            overflow: hidden;
        }
        .product-name-col { float: left; }
        .product-price-col { float: right; font-weight: 600; }
        
        /* --- Totals Summary Block --- */
        .totals-section {
            width: 350px; 
            float: right;
            margin-top: 16px;
        }
        .totals-table {
            width: 100%;
            border-collapse: collapse;
        }
        .totals-table td {
            padding: 6px 0;
            border: none;
            font-size: 10pt;
        }
        .totals-table .label {
            text-align: left;
        }
        .totals-table .amount {
            text-align: right;
            font-weight: 600;
        }
        .total-row-separator td {
            border-top: 1px dashed #e5e7eb;
            padding-top: 8px;
            margin-top: 8px;
        }
        .grand-total-row td {
            border-top: 2px solid #111827;
            font-weight: 700;
            font-size: 11pt;
            padding-top: 8px;
            color: #667eea;
        }
        .payment-received-row td {
            font-size: 12pt;
            font-weight: 800;
            background-color: #d1fae5;
            color: #059669;
            padding: 10px 15px;
            margin-top: 10px;
        }
        .balance-due-row td {
            font-size: 12pt;
            font-weight: 800;
            background-color: #fef3c7;
            color: #d97706;
            padding: 10px 15px;
            margin-top: 10px;
        }

        /* --- Footer --- */
        .clearfix { clear: both; }
        .footer {
            margin-top: 40px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
            text-align: center;
            font-size: 9pt;
            color: #6b7280; 
        }
    </style>
</head>
<body>
    
    <table class="header-top">
        <tr>
            <td class="logo-section">
                <div style="width: 50px; height: 50px; background-color: #667eea; border-radius: 4px; float: left; margin-right: 10px;"></div>
                <div>
                    <div class="clinic-logo-text">YOUR DENTAL CLINIC</div>
                    <div class="clinic-tagline">For beautiful smiles</div>
                </div>
                
                <div class="bill-to">
                    <div class="label">Patient (Bill To):</div>
                    <div style="font-weight: 600; font-size: 10pt; color: #111827;">{{ patient.full_name }}</div>
                    <div style="font-size: 9pt; margin-top: 2px;">{{ patient.contact_number|default:'—' }}</div>
                </div>
            </td>
            <td class="meta-section">
                <div class="receipt-title">RECEIPT</div>
                
                <div class="receipt-meta-item">
                    <strong style="color: #6b7280;">Receipt No.:</strong>
                    <span>#{{ transaction.receipt_number }}</span>
                </div>
                <div class="receipt-meta-item">
                    <strong style="color: #6b7280;">Invoice Ref:</strong>
                    <span>#{{ transaction.payment.id|stringformat:"06d" }}</span>
                </div>
                <div class="receipt-meta-item">
                    <strong style="color: #6b7280;">Payment Date:</strong>
                    <span>{{ transaction.payment_date|date:"F d, Y" }}</span>
                </div>
                <div class="receipt-meta-item">
                    <strong style="color: #6b7280;">Status:</strong>
                    {% if payment.outstanding_balance > 0 %}
                        <span class="status-badge status-partial">PARTIAL PAYMENT</span>
                    {% else %}
                        <span class="status-badge status-paid">PAID IN FULL</span>
                    {% endif %}
                </div>
            </td>
        </tr>
    </table>

    <div class="clearfix"></div>

    <table class="items-table">
        <thead>
            <tr>
                <th style="width: 50%;">Service / Treatment Description</th>
                <th style="width: 25%; text-align: center;">Base Fee (P)</th>
                <th style="width: 25%; text-align: right;">Item Total (P)</th>
            </tr>
        </thead>
        <tbody>
            {% for item in payment_items %}
                {% if item.price >= 0 %}
                <tr>
                    <td>
                        <strong style="font-size: 10.5pt; color: #111827;">{{ item.service.name }}</strong>
                        {% if item.notes %}
                        <div style="font-style: italic; font-size: 9pt; color: #6b7280; margin-top: 4px;">Note: {{ item.notes }}</div>
                        {% endif %}
                        
                        {% if item.products.all or item.discount %}
                        <ul class="product-list">
                            {% if item.products.all %}
                            <li style="font-weight: 600; margin-top: 4px; color: #667eea;">— Products Used —</li>
                            {% for product_item in item.products.all %}
                            <li>
                                <span class="product-name-col">
                                    • {{ product_item.product.name }}
                                    {% if product_item.quantity > 1 %}
                                    ({{ product_item.quantity }}x @ P{{ product_item.unit_price|floatformat:2 }})
                                    {% endif %}
                                </span>
                                <span class="product-price-col">P{{ product_item.subtotal|floatformat:2 }}</span>
                            </li>
                            {% endfor %}
                            {% endif %}
                            
                            {% if item.discount %}
                            <li style="font-weight: 600; color: #059669;">
                                <span class="product-name-col">Discount ({{ item.discount.name }})</span>
                                <span class="product-price-col">-P{{ item.discount_amount|floatformat:2 }}</span>
                            </li>
                            {% endif %}
                        </ul>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        P{{ item.price|floatformat:2 }}
                    </td>
                    <td style="text-align: right; font-weight: 600; color: #667eea;">
                        P{{ item.total|floatformat:2 }}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <div class="clearfix"></div>

    <div class="totals-section">
        <table class="totals-table">
            <tr>
                <td class="label">Total Invoice Amount:</td>
                <td class="amount">P{{ payment.total_amount|floatformat:2 }}</td>
            </tr>

            {% if previous_payments_total > 0 and payment.amount_paid > transaction.amount %}
            <tr class="total-row-separator">
                <td class="label" style="font-weight: 400; color: #d97706;">Previously Paid:</td>
                <td class="amount" style="color: #d97706;">P{{ previous_payments_total|floatformat:2 }}</td>
            </tr>
            {% endif %}

            <tr>
                <td class="label" style="font-weight: 400;">Current Balance Due:</td>
                <td class="amount">P{{ payment.total_amount|floatformat:2 }}</td>
            </tr>

            <tr class="payment-received-row">
                <td>PAYMENT RECEIVED</td>
                <td>P{{ transaction.amount|floatformat:2 }}</td>
            </tr>
            
            {% if payment.outstanding_balance > 0 %}
            <tr class="balance-due-row">
                <td>OUTSTANDING BALANCE REMAINING</td>
                <td>P{{ payment.outstanding_balance|floatformat:2 }}</td>
            </tr>
            {% endif %}
        </table>
    </div>

    <div class="clearfix"></div>
    
    <div class="footer">
        <div style="font-size: 14pt; font-weight: 700; color: #111827; margin-bottom: 5px;">Thank You for Your Payment!</div>
        <div style="margin: 3px 0;">This official receipt is for your records. Generated by {{ transaction.created_by.get_full_name|default:transaction.created_by.username }}.</div>
        
        {% if transaction.notes %}
        <div style="margin-top: 15px; padding: 10px; background-color: #fef3c7; border-radius: 4px; font-style: italic; color: #d97706; font-size: 9pt; display: inline-block;">
            <strong>Transaction Note:</strong> {{ transaction.notes }}
        </div>
        {% endif %}
        
        <div style="margin-top: 20px; font-size: 8pt; color: #adb5bd; padding-top: 10px; border-top: 1px solid #e5e7eb;">
            {{ clinic_address }} | Tel: {{ clinic_phone }} | Email: {{ clinic_email }}
        </div>
    </div>
</body>
</html>
<!-- templates/reports/reports_dashboard.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Reports & Analytics - {{ block.super }}{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" 
        integrity="sha512-CQBWl4fJHWbryGE+Pc7UAxWMUMNMWzWxF4SQo9CgkJIN1kx6djDQZjh3Y8SZ1d+6I+1zze6Z7kHXO7q3UyZAWw==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer"></script>
{% endblock %}

{% block content %}

<style>
    .report-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s;
    }
    
    .report-card:hover {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
    }
    
    .metric-label {
        font-size: 0.875rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 1rem;
    }
</style>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">Reports & Analytics</h1>
        <p class="mt-2 text-sm text-gray-700">Comprehensive insights into your clinic's performance</p>
    </div>
    
    <!-- Date Range Filter -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <form method="get" action="{% url 'reports:dashboard' %}" class="flex flex-wrap items-end gap-4">
            
            <!-- Date Range Selector -->
            <div class="flex-1 min-w-[200px]">
                <label for="date_range" class="block text-sm font-medium text-gray-700 mb-1">
                    üìÖ Date Range
                </label>
                <select name="date_range" id="date_range" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="today" {% if date_range == 'today' %}selected{% endif %}>Today</option>
                    <option value="yesterday" {% if date_range == 'yesterday' %}selected{% endif %}>Yesterday</option>
                    <option value="last_7_days" {% if date_range == 'last_7_days' %}selected{% endif %}>Last 7 Days</option>
                    <option value="last_30_days" {% if date_range == 'last_30_days' %}selected{% endif %}>Last 30 Days</option>
                    <option value="custom" {% if date_range == 'custom' %}selected{% endif %}>Custom Range</option>
                </select>
            </div>
            
            <!-- Custom Date Inputs -->
            <div id="custom-dates" class="flex gap-4 {% if date_range != 'custom' %}hidden{% endif %}">
                <div>
                    <label for="custom_start" class="block text-sm font-medium text-gray-700 mb-1">
                        From
                    </label>
                    <input type="date" name="custom_start" id="custom_start" value="{{ custom_start }}"
                           class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="custom_end" class="block text-sm font-medium text-gray-700 mb-1">
                        To
                    </label>
                    <input type="date" name="custom_end" id="custom_end" value="{{ custom_end }}"
                           class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-2">
                <button type="submit" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                    Apply Filter
                </button>
                <a href="{% url 'reports:export_pdf' %}?date_range={{ date_range }}&custom_start={{ custom_start }}&custom_end={{ custom_end }}"
                   class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition"
                   target="_blank">
                    üìÑ Export PDF
                </a>
            </div>
        </form>
        
        <!-- Current Period Display -->
        <div class="mt-4 pt-4 border-t border-gray-200">
            <p class="text-lg text-gray-600">
                <strong>Report Period:</strong> 
                {{ start_date|date:"M d, Y" }} to {{ end_date|date:"M d, Y" }}
            </p>
        </div>
    </div>
    
    <!-- Report Sections -->
    
    <!-- Financial Summary -->
    {% include 'reports/partials/_financial_summary.html' %}
    
    <!-- Operational Statistics -->
    {% include 'reports/partials/_operational_stats.html' %}
    
    <!-- Analytics & Insights -->
    {% include 'reports/partials/_analytics_charts.html' %}
    
    <!-- Detailed Tables -->
    {% include 'reports/partials/_detailed_tables.html' %}
    
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>

(function() {
    'use strict';
    
    let chartInstances = {};
    let attempts = 0;
    const maxAttempts = 50;
    
    // Wait for Chart.js to load
    function waitForChart() {
        attempts++;
        
        if (typeof Chart !== 'undefined') {
            initializeDashboard();
        } else if (attempts < maxAttempts) {
            setTimeout(waitForChart, 100);
        } else {
            console.error('‚ùå Chart.js failed to load after 5 seconds');
            showChartError();
        }
    }
    
    // Show error message if charts fail to load
    function showChartError() {
        const canvases = document.querySelectorAll('canvas[id$="Chart"]');
        canvases.forEach(canvas => {
            const container = canvas.closest('.chart-container');
            if (container) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-text">Failed to load chart. Please refresh the page.</div></div>';
            }
        });
    }
    
    // Initialize dashboard functionality
    function initializeDashboard() {
        setupDateRangeToggle();
        setupCharts();
        setupFormValidation();
    }
    
    // Setup date range toggle functionality
    function setupDateRangeToggle() {
        const dateRangeSelect = document.getElementById('date_range');
        const customStartWrapper = document.getElementById('custom-start-wrapper');
        const customEndWrapper = document.getElementById('custom-end-wrapper');
        
        if (dateRangeSelect && customStartWrapper && customEndWrapper) {
            dateRangeSelect.addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                
                if (isCustom) {
                    customStartWrapper.classList.remove('hidden');
                    customEndWrapper.classList.remove('hidden');
                    
                    // Set focus to first date input
                    const customStartInput = document.getElementById('custom_start');
                    if (customStartInput) {
                        setTimeout(() => customStartInput.focus(), 100);
                    }
                } else {
                    customStartWrapper.classList.add('hidden');
                    customEndWrapper.classList.add('hidden');
                }
            });
        }
    }
    
    // Setup form validation
    function setupFormValidation() {
        const filterForm = document.getElementById('filterForm');
        
        if (filterForm) {
            filterForm.addEventListener('submit', function(e) {
                const dateRange = document.getElementById('date_range').value;
                
                if (dateRange === 'custom') {
                    const customStart = document.getElementById('custom_start').value;
                    const customEnd = document.getElementById('custom_end').value;
                    
                    if (!customStart || !customEnd) {
                        e.preventDefault();
                        alert('Please select both start and end dates for custom range.');
                        return false;
                    }
                    
                    // Validate that end date is after start date
                    if (new Date(customEnd) < new Date(customStart)) {
                        e.preventDefault();
                        alert('End date must be after start date.');
                        return false;
                    }
                }
            });
        }
    }
    
    // Setup all charts
    function setupCharts() {
        // Chart.js global defaults
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
        Chart.defaults.plugins.legend.position = 'bottom';
        Chart.defaults.plugins.legend.labels.padding = 15;
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.legend.labels.pointStyle = 'circle';
        
        // Color palette
        const colors = {
            blue: '#3b82f6',
            green: '#10b981',
            yellow: '#f59e0b',
            red: '#ef4444',
            purple: '#8b5cf6',
            indigo: '#6366f1',
            gray: '#6b7280',
            pink: '#ec4899',
            teal: '#14b8a6',
            orange: '#f97316'
        };
        
        // Initialize each chart
        initStatusChart(colors);
        initDailyScheduleChart(colors);
        initServicesCountChart(colors);
        initServicesRevenueChart(colors);
        initPatientTypeChart(colors);
    }
    
    // Status Chart (Doughnut)
    function initStatusChart(colors) {
        const canvas = document.getElementById('statusChart');
        if (!canvas) return;
        
        const statusLabels = [];
        const statusData = [];
        
        // Parse data from Django template
        {% for status in appointments_by_status %}
            statusLabels.push('{{ status.status|title }}');
            statusData.push({{ status.count }});
        {% endfor %}
        
        if (statusLabels.length === 0 || statusData.length === 0) return;
        
        const backgroundColors = [
            colors.green,
            colors.blue,
            colors.yellow,
            colors.red,
            colors.gray,
            colors.purple,
            colors.pink,
            colors.orange
        ];
        
        chartInstances.status = new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusData,
                    backgroundColor: backgroundColors.slice(0, statusLabels.length),
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 12,
                            font: { size: 13 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 13, weight: '600' },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Daily Schedule Chart (Stacked Bar)
    function initDailyScheduleChart(colors) {
        const canvas = document.getElementById('dailyScheduleChart');
        if (!canvas) return;
        
        const dailyLabels = [];
        const amData = [];
        const pmData = [];
        
        {% for day in daily_schedule %}
            dailyLabels.push('{{ day.appointment_date|date:"M d" }}');
            amData.push({{ day.am_count }});
            pmData.push({{ day.pm_count }});
        {% endfor %}
        
        if (dailyLabels.length === 0) return;
        
        chartInstances.daily = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: dailyLabels,
                datasets: [
                    {
                        label: 'Morning (AM)',
                        data: amData,
                        backgroundColor: colors.blue,
                        borderRadius: 6,
                        borderSkipped: false
                    },
                    {
                        label: 'Afternoon (PM)',
                        data: pmData,
                        backgroundColor: colors.green,
                        borderRadius: 6,
                        borderSkipped: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false },
                        ticks: { font: { size: 12 } }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            font: { size: 12 }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 13 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 13, weight: '600' },
                        bodyFont: { size: 13 }
                    }
                }
            }
        });
    }
    
    // Services Count Chart (Horizontal Bar)
    function initServicesCountChart(colors) {
        const canvas = document.getElementById('servicesCountChart');
        if (!canvas) return;
        
        const countLabels = [];
        const countData = [];
        
        {% for service in popular_services_by_count %}
            countLabels.push('{{ service.service__name|truncatechars:30|escapejs }}');
            countData.push({{ service.service_count }});
        {% endfor %}
        
        if (countLabels.length === 0) return;
        
        chartInstances.count = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: countLabels,
                datasets: [{
                    label: 'Times Performed',
                    data: countData,
                    backgroundColor: colors.blue,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            font: { size: 12 }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { font: { size: 12 } }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 13, weight: '600' },
                        bodyFont: { size: 13 }
                    }
                }
            }
        });
    }
    
    // Services Revenue Chart (Horizontal Bar)
    function initServicesRevenueChart(colors) {
        const canvas = document.getElementById('servicesRevenueChart');
        if (!canvas) return;
        
        const revenueLabels = [];
        const revenueData = [];
        
        {% for service in popular_services_by_revenue %}
            revenueLabels.push('{{ service.service__name|truncatechars:30|escapejs }}');
            revenueData.push({{ service.total_revenue }});
        {% endfor %}
        
        if (revenueLabels.length === 0) return;
        
        chartInstances.revenue = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: revenueLabels,
                datasets: [{
                    label: 'Revenue (‚Ç±)',
                    data: revenueData,
                    backgroundColor: colors.green,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            font: { size: 12 },
                            callback: function(value) {
                                return '‚Ç±' + value.toLocaleString('en-PH');
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { font: { size: 12 } }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 13, weight: '600' },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: function(context) {
                                return 'Revenue: ‚Ç±' + context.parsed.x.toLocaleString('en-PH');
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Patient Type Chart (Pie)
    function initPatientTypeChart(colors) {
        const canvas = document.getElementById('patientTypeChart');
        if (!canvas) return;
        
        const newPatients = {{ new_patients|default:0 }};
        const returningPatients = {{ returning_patients|default:0 }};
        
        if (newPatients === 0 && returningPatients === 0) return;
        
        chartInstances.patientType = new Chart(canvas, {
            type: 'pie',
            data: {
                labels: ['New Patients', 'Returning Patients'],
                datasets: [{
                    data: [newPatients, returningPatients],
                    backgroundColor: [colors.purple, colors.indigo],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 13 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 13, weight: '600' },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: function(context) {
                                const total = newPatients + returningPatients;
                                const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        Object.keys(chartInstances).forEach(key => {
            if (chartInstances[key]) {
                chartInstances[key].destroy();
            }
        });
    });
    
    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForChart);
    } else {
        waitForChart();
    }
})();
</script>
{% endblock %}
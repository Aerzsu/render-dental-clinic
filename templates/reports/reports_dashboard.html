<!-- templates/reports/reports_dashboard.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Reports & Analytics - {{ block.super }}{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" 
        integrity="sha512-CQBWl4fJHWbryGE+Pc7UAxWMUMNMWzWxF4SQo9CgkJIN1kx6djDQZjh3Y8SZ1d+6I+1zze6Z7kHXO7q3UyZAWw==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer"></script>
{% endblock %}

{% block content %}

<style>
    .report-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s;
    }
    
    .report-card:hover {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
    }
    
    .metric-label {
        font-size: 0.875rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 1rem;
    }
</style>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">Reports & Analytics</h1>
        <p class="mt-2 text-sm text-gray-700">Comprehensive insights into your clinic's performance</p>
    </div>
    
    <!-- Date Range Filter -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <form method="get" action="{% url 'reports:dashboard' %}" class="flex flex-wrap items-end gap-4">
            
            <!-- Date Range Selector -->
            <div class="flex-1 min-w-[200px]">
                <label for="date_range" class="block text-sm font-medium text-gray-700 mb-1">
                    ðŸ“… Date Range
                </label>
                <select name="date_range" id="date_range" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="today" {% if date_range == 'today' %}selected{% endif %}>Today</option>
                    <option value="yesterday" {% if date_range == 'yesterday' %}selected{% endif %}>Yesterday</option>
                    <option value="last_7_days" {% if date_range == 'last_7_days' %}selected{% endif %}>Last 7 Days</option>
                    <option value="last_30_days" {% if date_range == 'last_30_days' %}selected{% endif %}>Last 30 Days</option>
                    <option value="custom" {% if date_range == 'custom' %}selected{% endif %}>Custom Range</option>
                </select>
            </div>
            
            <!-- Custom Date Inputs -->
            <div id="custom-dates" class="flex gap-4 {% if date_range != 'custom' %}hidden{% endif %}">
                <div>
                    <label for="custom_start" class="block text-sm font-medium text-gray-700 mb-1">
                        From
                    </label>
                    <input type="date" name="custom_start" id="custom_start" value="{{ custom_start }}"
                           class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="custom_end" class="block text-sm font-medium text-gray-700 mb-1">
                        To
                    </label>
                    <input type="date" name="custom_end" id="custom_end" value="{{ custom_end }}"
                           class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-2">
                <button type="submit" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                    Apply Filter
                </button>
                <a href="{% url 'reports:export_pdf' %}?date_range={{ date_range }}&custom_start={{ custom_start }}&custom_end={{ custom_end }}"
                   class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition"
                   target="_blank">
                    ðŸ“„ Export PDF
                </a>
            </div>
        </form>
        
        <!-- Current Period Display -->
        <div class="mt-4 pt-4 border-t border-gray-200">
            <p class="text-lg text-gray-600">
                <strong>Report Period:</strong> 
                {{ start_date|date:"M d, Y" }} to {{ end_date|date:"M d, Y" }}
            </p>
        </div>
    </div>
    
    <!-- Report Sections -->
    
    <!-- Financial Summary -->
    {% include 'reports/partials/_financial_summary.html' %}
    
    <!-- Operational Statistics -->
    {% include 'reports/partials/_operational_stats.html' %}
    
    <!-- Analytics & Insights -->
    {% include 'reports/partials/_analytics_charts.html' %}
    
    <!-- Detailed Tables -->
    {% include 'reports/partials/_detailed_tables.html' %}
    
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>

(function() {
    'use strict';
    
    let attempts = 0;
    const maxAttempts = 50;
    
    function waitForChart() {
        attempts++;
        
        if (typeof Chart !== 'undefined') {
            initializeCharts();
        } else if (attempts < maxAttempts) {
            setTimeout(waitForChart, 100);
        } else {
            console.error('âŒ Chart.js failed to load after 5 seconds');
        }
    }
    
    function initializeCharts() {
        
        // Date range toggle
        const dateRangeSelect = document.getElementById('date_range');
        if (dateRangeSelect) {
            dateRangeSelect.addEventListener('change', function() {
                const customDates = document.getElementById('custom-dates');
                if (this.value === 'custom') {
                    customDates.classList.remove('hidden');
                } else {
                    customDates.classList.add('hidden');
                }
            });
        }

        const chartColors = {
            blue: 'rgb(59, 130, 246)',
            green: 'rgb(16, 185, 129)',
            yellow: 'rgb(245, 158, 11)',
            red: 'rgb(239, 68, 68)',
            purple: 'rgb(139, 92, 246)',
            indigo: 'rgb(99, 102, 241)',
            gray: 'rgb(107, 114, 128)',
        };

        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        Chart.defaults.plugins.legend.position = 'bottom';

        // STATUS CHART
        const statusCanvas = document.getElementById('statusChart');
        if (statusCanvas) {
            const statusLabels = [{% for status in appointments_by_status %}'{{ status.status|title }}'{% if not forloop.last %},{% endif %}{% endfor %}];
            const statusData = [{% for status in appointments_by_status %}{{ status.count }}{% if not forloop.last %},{% endif %}{% endfor %}];
            
            if (statusLabels.length > 0 && statusData.length > 0) {
                new Chart(statusCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            data: statusData,
                            backgroundColor: [chartColors.green, chartColors.blue, chartColors.yellow, chartColors.red, chartColors.gray, chartColors.purple]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right' } }
                    }
                });
            }
        }

        // DAILY SCHEDULE CHART
        const dailyCanvas = document.getElementById('dailyScheduleChart');
        if (dailyCanvas) {
            const dailyLabels = [{% for day in daily_schedule %}'{{ day.appointment_date|date:"M d" }}'{% if not forloop.last %},{% endif %}{% endfor %}];
            const amData = [{% for day in daily_schedule %}{{ day.am_count }}{% if not forloop.last %},{% endif %}{% endfor %}];
            const pmData = [{% for day in daily_schedule %}{{ day.pm_count }}{% if not forloop.last %},{% endif %}{% endfor %}];
            
            if (dailyLabels.length > 0) {
                new Chart(dailyCanvas, {
                    type: 'bar',
                    data: {
                        labels: dailyLabels,
                        datasets: [
                            { label: 'AM', data: amData, backgroundColor: chartColors.blue },
                            { label: 'PM', data: pmData, backgroundColor: chartColors.green }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } }
                        }
                    }
                });
            }
        }

        // SERVICES COUNT CHART
        const countCanvas = document.getElementById('servicesCountChart');
        if (countCanvas) {
            const countLabels = [{% for service in popular_services_by_count %}'{{ service.service__name|truncatechars:20 }}'{% if not forloop.last %},{% endif %}{% endfor %}];
            const countData = [{% for service in popular_services_by_count %}{{ service.service_count }}{% if not forloop.last %},{% endif %}{% endfor %}];
            
            if (countLabels.length > 0) {
                new Chart(countCanvas, {
                    type: 'bar',
                    data: {
                        labels: countLabels,
                        datasets: [{ label: 'Times Performed', data: countData, backgroundColor: chartColors.blue }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: { x: { beginAtZero: true, ticks: { precision: 0 } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        // REVENUE CHART
        const revenueCanvas = document.getElementById('servicesRevenueChart');
        if (revenueCanvas) {
            const revenueLabels = [{% for service in popular_services_by_revenue %}'{{ service.service__name|truncatechars:20 }}'{% if not forloop.last %},{% endif %}{% endfor %}];
            const revenueData = [{% for service in popular_services_by_revenue %}{{ service.total_revenue }}{% if not forloop.last %},{% endif %}{% endfor %}];
            
            if (revenueLabels.length > 0) {
                new Chart(revenueCanvas, {
                    type: 'bar',
                    data: {
                        labels: revenueLabels,
                        datasets: [{ label: 'Revenue (â‚±)', data: revenueData, backgroundColor: chartColors.green }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { callback: function(value) { return 'â‚±' + value.toLocaleString(); } }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: function(context) { return 'â‚±' + context.parsed.x.toLocaleString(); } } }
                        }
                    }
                });
            }
        }

        // PATIENT TYPE CHART
        const patientTypeCanvas = document.getElementById('patientTypeChart');
        if (patientTypeCanvas) {
            const newPatients = {{ new_patients|default:0 }};
            const returningPatients = {{ returning_patients|default:0 }};
            
            console.log('ðŸ‘¥ Patient chart:', newPatients, returningPatients);
            
            if (newPatients > 0 || returningPatients > 0) {
                new Chart(patientTypeCanvas, {
                    type: 'pie',
                    data: {
                        labels: ['New Patients', 'Returning Patients'],
                        datasets: [{ data: [newPatients, returningPatients], backgroundColor: [chartColors.purple, chartColors.indigo] }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = newPatients + returningPatients;
                                        const pct = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                        return context.label + ': ' + context.parsed + ' (' + pct + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    }
    
    // Start waiting for Chart.js
    waitForChart();
})();
</script>
{% endblock %}
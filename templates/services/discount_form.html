{% extends 'base.html' %}

{% block title %}
    {% if object %}Edit Discount{% else %}Add New Discount{% endif %} - KingJoy Appointment System
{% endblock %}

{% block content %}
<style>
    /* Form Input Styles - Match Service Form */
    input:not([type="checkbox"]):not([type="radio"]),
    select,
    textarea {
        display: block;
        width: 100%;
        padding: 0.625rem 0.875rem;
        font-size: 0.875rem;
        line-height: 1.5;
        color: #1f2937;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    input:not([type="checkbox"]):not([type="radio"]):focus,
    select:focus,
    textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    input:not([type="checkbox"]):not([type="radio"]):disabled,
    select:disabled,
    textarea:disabled {
        background-color: #f3f4f6;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    /* Error state */
    input.error,
    select.error,
    textarea.error {
        border-color: #ef4444;
    }
    
    input.error:focus,
    select.error:focus,
    textarea.error:focus {
        border-color: #dc2626;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    
    /* Price input prefix - Match Service Form */
    .input-with-prefix {
        position: relative;
    }
    
    .input-prefix {
        position: absolute;
        left: 0.875rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.875rem;
        font-weight: 600;
        color: #6b7280;
        pointer-events: none;
        z-index: 10;
        user-select: none;
    }
    
    .input-with-prefix input[type="number"] {
        padding-left: 2.5rem;
        font-weight: 500;
    }

    .input-with-prefix input[type="number"]::placeholder {
        color: #9ca3af;
        opacity: 1;
    }
    
    /* Required indicator */
    .required-indicator {
        color: #dc2626;
        font-weight: 600;
        margin-left: 0.125rem;
    }
    
    /* Helper text */
    .helper-text {
        display: flex;
        align-items: start;
        gap: 0.375rem;
        margin-top: 0.5rem;
        font-size: 0.8125rem;
        color: #6b7280;
        line-height: 1.4;
    }
    
    .helper-icon {
        width: 0.875rem;
        height: 0.875rem;
        flex-shrink: 0;
        margin-top: 0.125rem;
        color: #9ca3af;
    }
    
    /* Button styles */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        font-size: 0.875rem;
        font-weight: 500;
        line-height: 1.25rem;
        border-radius: 0.375rem;
        transition: all 0.15s ease-in-out;
        cursor: pointer;
        text-decoration: none;
    }
    
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .btn-primary {
        color: #ffffff;
        background-color: #2563eb;
        border: 1px solid transparent;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    
    .btn-primary:hover:not(:disabled) {
        background-color: #1d4ed8;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }
    
    .btn-secondary {
        color: #374151;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
    }
    
    .btn-secondary:hover:not(:disabled) {
        background-color: #f9fafb;
        border-color: #9ca3af;
    }
    
    .btn-secondary:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.2);
    }
    
    /* Radio button styling */
    input[type="radio"] {
        cursor: pointer;
    }
    
    input[type="radio"]:checked {
        background-color: #2563eb;
        border-color: #2563eb;
    }
    
    label:has(input[type="radio"]:checked) {
        border-color: #2563eb;
        background-color: #eff6ff;
    }
    
    /* Loading animation */
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    
    /* Number input - hide spinner */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    input[type="number"] {
        -moz-appearance: textfield;
    }
    
    /* Smooth transitions */
    * {
        transition-property: background-color, border-color, color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
    }
    
    /* Focus visible for accessibility */
    *:focus-visible {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
    }
</style>

<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumb Navigation -->
        <nav class="flex mb-4" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2 text-sm">
                <li>
                    <a href="{% url 'services:discount_list' %}" 
                       class="text-gray-500 hover:text-gray-700 transition-colors font-medium">
                        <span class="sr-only">Back to </span>Discounts
                    </a>
                </li>
                {% if object %}
                <li class="flex items-center">
                    <svg class="flex-shrink-0 w-4 h-4 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                    <a href="{% url 'services:discount_detail' object.pk %}" 
                       class="text-gray-500 hover:text-gray-700 transition-colors font-medium">
                        {{ object.name }}
                    </a>
                </li>
                {% endif %}
                <li class="flex items-center">
                    <svg class="flex-shrink-0 w-4 h-4 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-gray-900 font-medium">{% if object %}Edit{% else %}New Discount{% endif %}</span>
                </li>
            </ol>
        </nav>

        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        {% if object %}Edit Discount{% else %}Add New Discount{% endif %}
                    </h1>
                    <p class="text-gray-600">
                        {% if object %}Update the discount details and configuration{% else %}Create a new discount that can be applied to services and billing{% endif %}
                    </p>
                </div>
                <div class="ml-4 flex-shrink-0">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                        </svg>
                        Discount
                    </span>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Form Column (2/3 width) -->
            <div class="lg:col-span-2">
                <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                    <form method="post" class="divide-y divide-gray-200" id="discount-form" novalidate>
                        {% csrf_token %}
                        
                        <!-- Display non-field errors -->
                        {% if form.non_field_errors %}
                            <div class="p-6">
                                <div class="rounded-lg bg-red-50 border border-red-200 p-4">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-sm font-semibold text-red-800 mb-2">Please correct the following errors:</h3>
                                            <ul class="list-disc list-inside space-y-1 text-sm text-red-700">
                                                {% for error in form.non_field_errors %}
                                                    <li>{{ error }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        <!-- Discount Details Section -->
                        <div class="p-6 space-y-6">
                            <div>
                                <div class="flex items-center mb-4">
                                    <svg class="w-5 h-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <h2 class="text-lg font-semibold text-gray-900">Discount Details</h2>
                                </div>

                                <!-- Discount Name -->
                                <div>
                                    <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-1.5">
                                        Discount Name <span class="required-indicator" aria-label="required">*</span>
                                    </label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <p class="mt-2 text-sm text-red-600" role="alert">
                                            <span class="font-medium">Error:</span> {{ form.name.errors.0 }}
                                        </p>
                                    {% endif %}
                                    <div class="helper-text">
                                        <svg class="helper-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span>Enter a clear, descriptive name (e.g., "Senior Citizen", "PWD", "Holiday Promo")</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Discount Configuration Section -->
                        <div class="p-6 space-y-6">
                            <div>
                                <div class="flex items-center mb-4">
                                    <svg class="w-5 h-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <h2 class="text-lg font-semibold text-gray-900">Discount Configuration</h2>
                                </div>

                                <!-- Discount Type Selection -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-900 mb-3">
                                            Discount Type <span class="required-indicator" aria-label="required">*</span>
                                        </label>
                                        <div class="space-y-3">
                                            <label class="relative flex items-start p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-primary-500 hover:bg-primary-50 transition-all group">
                                                <input type="radio" 
                                                       name="discount_type" 
                                                       id="fixed_amount" 
                                                       value="false"
                                                       {% if not form.is_percentage.value %}checked{% endif %}
                                                       class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300 mt-0.5 flex-shrink-0">
                                                <div class="ml-3 flex-1">
                                                    <span class="block text-sm font-medium text-gray-900 group-hover:text-primary-900">
                                                        Fixed Amount (₱)
                                                    </span>
                                                    <span class="block text-xs text-gray-500 mt-1">
                                                        Subtract a specific peso amount from the total
                                                    </span>
                                                </div>
                                                <div class="ml-3">
                                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                </div>
                                            </label>
                                            
                                            <label class="relative flex items-start p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-primary-500 hover:bg-primary-50 transition-all group">
                                                <input type="radio" 
                                                       name="discount_type" 
                                                       id="percentage" 
                                                       value="true"
                                                       {% if form.is_percentage.value %}checked{% endif %}
                                                       class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300 mt-0.5 flex-shrink-0">
                                                <div class="ml-3 flex-1">
                                                    <span class="block text-sm font-medium text-gray-900 group-hover:text-primary-900">
                                                        Percentage (%)
                                                    </span>
                                                    <span class="block text-xs text-gray-500 mt-1">
                                                        Apply a percentage discount to the total amount
                                                    </span>
                                                </div>
                                                <div class="ml-3">
                                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                    </svg>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Hidden field for form submission -->
                                    {{ form.is_percentage }}

                                    <!-- Amount Field - EXACTLY MATCH SERVICE FORM STRUCTURE -->
                                    <div class="pt-2">
                                        <label for="{{ form.amount.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-1.5">
                                            <span id="amount-label">
                                                {% if form.is_percentage.value %}Discount Percentage{% else %}Discount Amount{% endif %}
                                            </span>
                                            <span class="required-indicator" aria-label="required">*</span>
                                        </label>
                                        <div class="input-with-prefix">
                                            <span class="input-prefix" id="currency-symbol" aria-hidden="true">
                                                {% if form.is_percentage.value %}%{% else %}₱{% endif %}
                                            </span>
                                            {{ form.amount }}
                                        </div>
                                        {% if form.amount.errors %}
                                            <p class="mt-2 text-sm text-red-600" role="alert">
                                                <span class="font-medium">Error:</span> {{ form.amount.errors.0 }}
                                            </p>
                                        {% endif %}
                                        <div class="helper-text">
                                            <svg class="helper-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <span id="amount-help">
                                                {% if form.is_percentage.value %}
                                                    Enter a percentage between 1 and 100 to discount from the total amount
                                                {% else %}
                                                    Enter the fixed peso amount to subtract from the total
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="px-6 py-4 bg-gray-50 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                            <a href="{% url 'services:discount_list' %}" class="btn btn-secondary">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Cancel
                            </a>
                            <button type="submit" 
                                    id="submitBtn"
                                    class="btn btn-primary">
                                <svg class="w-4 h-4 hidden animate-spin" id="loadingIcon" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span id="submitText">{% if object %}Update Discount{% else %}Create Discount{% endif %}</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar Column (1/3 width) -->
            <div class="lg:col-span-1">
                <div class="sticky top-6 space-y-6">
                    <!-- Discount Preview Card -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-4 py-3 bg-gradient-to-r from-primary-50 to-primary-100 border-b border-primary-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-primary-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <h3 class="text-sm font-semibold text-primary-900">Live Preview</h3>
                            </div>
                        </div>
                        <div class="p-4 space-y-4">
                            <div>
                                <p class="text-xs font-medium text-gray-500 mb-1">Example Calculation</p>
                                <div class="bg-gray-50 rounded-lg p-3 space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Original Amount:</span>
                                        <span class="font-medium text-gray-900">₱1,000</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Discount:</span>
                                        <span class="font-medium text-primary-600" id="preview-discount">-</span>
                                    </div>
                                    <div class="pt-2 border-t border-gray-200 flex justify-between">
                                        <span class="text-sm font-medium text-gray-900">Final Amount:</span>
                                        <span class="text-lg font-bold text-gray-900" id="preview-final">₱1,000</span>
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 italic">
                                Preview updates as you enter the discount amount
                            </p>
                        </div>
                    </div>

                    <!-- Helpful Tips Card -->
                    <div class="bg-blue-50 rounded-lg border border-blue-200 overflow-hidden">
                        <div class="px-4 py-3 bg-blue-100 border-b border-blue-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                                <h3 class="text-sm font-semibold text-blue-900">Helpful Tips</h3>
                            </div>
                        </div>
                        <div class="p-4">
                            <ul class="space-y-2.5 text-sm text-blue-900">
                                <li class="flex items-start">
                                    <svg class="w-4 h-4 text-blue-600 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                    </svg>
                                    <span>Use descriptive names to easily identify discounts during billing</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-4 h-4 text-blue-600 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                    </svg>
                                    <span>Fixed amounts work best for consistent discounts (e.g., ₱100 off)</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-4 h-4 text-blue-600 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                    </svg>
                                    <span>Percentage discounts scale better with varying bill amounts</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-4 h-4 text-blue-600 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                    </svg>
                                    <span>Common examples: Senior Citizen (20%), PWD (20%), Holiday Promo (10%)</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Quick Reference Card -->
                    <div class="bg-gray-50 rounded-lg border border-gray-200 p-4 hidden lg:block">
                        <h3 class="text-sm font-semibold text-gray-900 mb-3">Quick Reference</h3>
                        <dl class="space-y-2 text-xs text-gray-600">
                            <div class="flex justify-between py-1">
                                <dt>Required fields:</dt>
                                <dd class="font-medium text-gray-900">Name, Amount</dd>
                            </div>
                            <div class="flex justify-between py-1">
                                <dt>Percentage range:</dt>
                                <dd class="font-medium text-gray-900">1% - 100%</dd>
                            </div>
                            <div class="flex justify-between py-1">
                                <dt>Min. amount:</dt>
                                <dd class="font-medium text-gray-900">₱1</dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    const form = document.getElementById('discount-form');
    const fixedRadio = document.getElementById('fixed_amount');
    const percentageRadio = document.getElementById('percentage');
    const hiddenField = document.getElementById('{{ form.is_percentage.id_for_label }}');
    const amountInput = document.getElementById('{{ form.amount.id_for_label }}');
    const amountLabel = document.getElementById('amount-label');
    const currencySymbol = document.getElementById('currency-symbol');
    const amountHelp = document.getElementById('amount-help');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingIcon = document.getElementById('loadingIcon');
    
    // Preview elements
    const previewDiscount = document.getElementById('preview-discount');
    const previewFinal = document.getElementById('preview-final');
    const baseAmount = 1000;
    
    function updateUI(isPercentage, clearAmount = true) {
        // Update hidden field value
        hiddenField.value = isPercentage ? 'True' : 'False';
        
        // Update label, symbol, and help text
        if (isPercentage) {
            amountLabel.textContent = 'Discount Percentage';
            currencySymbol.textContent = '%';
            amountInput.setAttribute('max', '100');
            amountInput.setAttribute('min', '1');
            amountHelp.textContent = 'Enter a percentage between 1 and 100 to discount from the total amount';
        } else {
            amountLabel.textContent = 'Discount Amount';
            currencySymbol.textContent = '₱';
            amountInput.removeAttribute('max');
            amountInput.setAttribute('min', '1');
            amountHelp.textContent = 'Enter the fixed peso amount to subtract from the total';
        }
        
        // Clear current value only when user switches types
        if (clearAmount) {
            amountInput.value = '';
            amountInput.focus();
        }
        
        updatePreview();
    }
    
    function updatePreview() {
        const amount = parseInt(amountInput.value) || 0;
        const isPercentage = percentageRadio.checked;
        
        if (amount <= 0) {
            previewDiscount.textContent = '-';
            previewFinal.textContent = '₱1,000';
            return;
        }
        
        let discountAmount = 0;
        if (isPercentage) {
            discountAmount = Math.floor((baseAmount * amount) / 100);
            previewDiscount.textContent = `-₱${discountAmount} (${amount}%)`;
        } else {
            discountAmount = amount;
            previewDiscount.textContent = `-₱${discountAmount}`;
        }
        
        const finalAmount = Math.max(0, baseAmount - discountAmount);
        previewFinal.textContent = `₱${finalAmount}`;
    }
    
    // Initialize UI on page load based on hidden field value
    function initializeUI() {
        const hiddenValue = hiddenField.value;
        const isPercentage = hiddenValue === 'True' || hiddenValue === 'true';
        
        // Update radio buttons to match hidden field
        if (isPercentage) {
            percentageRadio.checked = true;
            fixedRadio.checked = false;
        } else {
            fixedRadio.checked = true;
            percentageRadio.checked = false;
        }
        
        // Update UI without clearing the amount field
        updateUI(isPercentage, false);
    }
    
    // Event listeners for radio button changes
    fixedRadio.addEventListener('change', function() {
        if (this.checked) {
            updateUI(false, true);
        }
    });
    
    percentageRadio.addEventListener('change', function() {
        if (this.checked) {
            updateUI(true, true);
        }
    });

    // Currency input: Prevent non-numeric input (INTEGER ONLY - MATCH SERVICE FORM)
    const currencyInputs = document.querySelectorAll('.input-with-prefix input[type="number"]');
    currencyInputs.forEach(function(input) {
        // Normalize any existing value on load
        if (input.value) {
            input.value = input.value.toString().replace(/\D/g, '');
        }

        // Prevent typing decimal points and non-numeric on keydown
        input.addEventListener('keydown', function(e) {
            // Allow control keys: backspace, delete, tab, escape, enter, arrows, home/end
            if ([8,46,9,27,13,35,36,37,38,39,40].indexOf(e.keyCode) !== -1 ||
                // Allow: Ctrl/Cmd combinations
                e.ctrlKey === true || e.metaKey === true) {
                return;
            }

            // Block decimal separators and non-numeric keys
            const isNumberKey = (e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 105);
            if (!isNumberKey) {
                e.preventDefault();
            }
        });

        // Sanitize on input to remove any non-digits (handles mobile and IME)
        input.addEventListener('input', function() {
            const digits = this.value.replace(/\D/g, '');
            if (this.value !== digits) {
                this.value = digits;
            }
            updatePreview();
        });
        
        // Prevent pasting non-numeric values
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text') || '';
            const numericValue = pastedText.replace(/[^0-9]/g, '');
            if (numericValue) {
                this.value = parseInt(numericValue, 10);
                updatePreview();
            }
        });
        
        // Strip decimals on blur and ensure integer value
        input.addEventListener('blur', function() {
            if (this.value) {
                const v = parseFloat(this.value);
                if (!isNaN(v)) {
                    this.value = Math.floor(v);
                } else {
                    this.value = '';
                }
                updatePreview();
            }
        });
    });

    // Update preview on amount input
    amountInput.addEventListener('input', updatePreview);
    
    // Form validation
    form.addEventListener('submit', function(e) {
        const amount = parseInt(amountInput.value);
        const isPercentage = percentageRadio.checked;
        
        if (!amount || amount <= 0) {
            e.preventDefault();
            alert('Please enter a valid discount amount greater than zero.');
            amountInput.focus();
            return false;
        }
        
        if (isPercentage && amount > 100) {
            e.preventDefault();
            alert('Percentage discount cannot exceed 100%.');
            amountInput.focus();
            return false;
        }
        
        // Show loading state
        submitBtn.disabled = true;
        submitText.textContent = '{% if object %}Updating...{% else %}Creating...{% endif %}';
        loadingIcon.classList.remove('hidden');
    });
    
    // Add error class to inputs with errors
    const formInputs = document.querySelectorAll('input, select, textarea');
    formInputs.forEach(function(input) {
        const errorElement = input.parentElement.querySelector('[role="alert"]');
        if (errorElement) {
            input.classList.add('error');
        }
    });

    // Initialize the UI on page load
    initializeUI();
});
</script>
{% endblock %}
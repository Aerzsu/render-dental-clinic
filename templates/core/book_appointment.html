{% extends "base_public.html" %}

{% block title %}Book Appointment - Dental Clinic{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8" x-data="appointmentBooking()">
    <!-- Header -->
    <div class="text-center mb-8">
        <div class="w-16 h-16 bg-primary-600 rounded-full mx-auto mb-4 flex items-center justify-center">
            <span class="text-white text-2xl">ðŸ¦·</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Book Your Appointment</h1>
        <p class="text-gray-600">Schedule your dental visit - simple 3-step process</p>
    </div>

    <!-- Progress Steps -->
    <div class="max-w-3xl mx-auto mb-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center" :class="step >= 1 ? 'text-primary-600' : 'text-gray-400'">
                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center" 
                     :class="step >= 1 ? 'border-primary-600 bg-primary-600 text-white' : 'border-gray-300'">
                    <span class="text-sm font-medium">1</span>
                </div>
                <span class="ml-2 text-sm font-medium">Patient Info</span>
            </div>
            <div class="flex-1 h-px mx-4" :class="step >= 2 ? 'bg-primary-600' : 'bg-gray-300'"></div>
            <div class="flex items-center" :class="step >= 2 ? 'text-primary-600' : 'text-gray-400'">
                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center" 
                     :class="step >= 2 ? 'border-primary-600 bg-primary-600 text-white' : 'border-gray-300'">
                    <span class="text-sm font-medium">2</span>
                </div>
                <span class="ml-2 text-sm font-medium">Service & Schedule</span>
            </div>
            <div class="flex-1 h-px mx-4" :class="step >= 3 ? 'bg-primary-600' : 'bg-gray-300'"></div>
            <div class="flex items-center" :class="step >= 3 ? 'text-primary-600' : 'text-gray-400'">
                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center" 
                     :class="step >= 3 ? 'border-primary-600 bg-primary-600 text-white' : 'border-gray-300'">
                    <span class="text-sm font-medium">3</span>
                </div>
                <span class="ml-2 text-sm font-medium">Confirm</span>
            </div>
        </div>
    </div>

    <!-- Error Banner -->
    <div x-show="errorMessage" class="max-w-3xl mx-auto mb-6">
        <div class="bg-red-50 border-l-4 border-red-400 p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L10 9.414l1.707-1.707a1 1 0 011.414 1.414L11.414 10l1.707 1.707a1 1 0 01-1.414 1.414L10 10.586l-1.707 1.707a1 1 0 01-1.414-1.414L8.586 10 6.879 8.293a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700" x-text="errorMessage"></p>
                </div>
                <div class="ml-auto pl-3">
                    <div class="-mx-1.5 -my-1.5">
                        <button type="button" @click="errorMessage = ''" class="inline-flex bg-red-50 rounded-md p-1.5 text-red-400 hover:bg-red-100">
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Important Notice -->
    <div class="max-w-3xl mx-auto mb-6">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        <strong>Important:</strong> This is an appointment request, not a confirmed booking. 
                        You will receive confirmation within 24 hours. Appointments are available Monday to Saturday.
                        Morning (AM): {{ am_period_display }} | Afternoon (PM): {{ pm_period_display }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div x-show="submitted" class="max-w-3xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden mb-2">
        <div class="p-8 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Request Submitted!</h2>
            <p class="text-gray-600 mb-4">Your appointment request has been successfully submitted.</p>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p class="text-sm text-blue-700">
                    <strong>Reference Number:</strong> <span x-text="referenceNumber"></span><br>
                    <strong>Date:</strong> <span x-text="formatDate(form.appointment_date)"></span><br>
                    <strong>Period:</strong> <span x-text="form.period === 'AM' ? 'Morning' : 'Afternoon'"></span><br>
                    Please keep this reference number for your records.
                </p>
            </div>
        </div>
    </div>

    <!-- Booking Form -->
    <form x-show="!submitted" class="max-w-3xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden" @submit.prevent="submitForm">
        <!-- Step 1: Patient Information -->
        <div x-show="step === 1">
            <div class="p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Patient Information</h2>
                
                <!-- Patient Type Selection -->
                <div class="mb-6">
                    <label class="text-base font-medium text-gray-900 block mb-3">Are you a new or existing patient? *</label>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <label class="relative">
                            <input type="radio" x-model="form.patient_type" value="new" class="sr-only" @change="handlePatientTypeChange()">
                            <div class="p-4 border rounded-lg cursor-pointer transition-all" 
                                 :class="form.patient_type === 'new' ? 'border-primary-600 bg-primary-50 ring-2 ring-primary-600' : 'border-gray-300 hover:border-gray-400'">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">ðŸ‘¤</div>
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900">New Patient</h3>
                                        <p class="text-sm text-gray-500">First time visiting our clinic</p>
                                    </div>
                                </div>
                            </div>
                        </label>
                        <label class="relative">
                            <input type="radio" x-model="form.patient_type" value="existing" class="sr-only" @change="handlePatientTypeChange()">
                            <div class="p-4 border rounded-lg cursor-pointer transition-all" 
                                 :class="form.patient_type === 'existing' ? 'border-primary-600 bg-primary-50 ring-2 ring-primary-600' : 'border-gray-300 hover:border-gray-400'">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">ðŸ‘¥</div>
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900">Existing Patient</h3>
                                        <p class="text-sm text-gray-500">I have visited this clinic before</p>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                    <p x-show="errors.patient_type" class="mt-2 text-sm text-red-600" x-text="errors.patient_type"></p>
                </div>

                <!-- Existing Patient OTP Flow -->
                <div x-show="form.patient_type === 'existing'" class="space-y-6">
                    <!-- Email Input with Send Code Button -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                        <div class="flex gap-2">
                            <input type="email" x-model="otp.email" 
                                   :disabled="otp.codeSent && !otp.verified"
                                   :class="['flex-1 px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500', 
                                            errors.otp_email ? 'border-red-300' : 'border-gray-300',
                                            (otp.codeSent && !otp.verified) ? 'bg-gray-50' : '']"
                                   placeholder="your@email.com"
                                   @input="clearErrors('otp_email')">
                            <button type="button" @click="sendOTPCode()" 
                                    :disabled="otp.sending || (otp.codeSent && !otp.canResend)"
                                    class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap">
                                <span x-show="!otp.sending" x-text="otp.codeSent ? 'Resend Code' : 'Send Code'"></span>
                                <span x-show="otp.sending">Sending...</span>
                            </button>
                        </div>
                        <p x-show="errors.otp_email" class="mt-1 text-sm text-red-600" x-text="errors.otp_email"></p>
                        <p x-show="otp.remainingAttempts !== null && otp.remainingAttempts < 3" 
                           class="mt-1 text-sm text-yellow-600">
                            <span x-text="otp.remainingAttempts"></span> verification request(s) remaining this hour
                        </p>
                    </div>

                    <!-- OTP Code Input (shown after code is sent) -->
                    <div x-show="otp.codeSent && !otp.verified">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Verification Code *</label>
                        <div class="flex gap-2">
                            <input type="text" x-model="otp.code" maxlength="6"
                                   :class="['flex-1 px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500', 
                                            errors.otp_code ? 'border-red-300' : 'border-gray-300']"
                                   placeholder="Enter 6-digit code"
                                   @input="clearErrors('otp_code')">
                            <button type="button" @click="verifyOTPCode()" 
                                    :disabled="otp.verifying"
                                    class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span x-show="!otp.verifying">Verify</span>
                                <span x-show="otp.verifying">Verifying...</span>
                            </button>
                        </div>
                        <p x-show="errors.otp_code" class="mt-1 text-sm text-red-600" x-text="errors.otp_code"></p>
                        <p class="mt-1 text-sm text-gray-500">Check your email for the 6-digit verification code (expires in 15 minutes)</p>
                    </div>

                    <!-- Patient Selection (shown after OTP verified with multiple patients) -->
                    <div x-show="otp.verified && otp.showPatientSelection">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Select Your Patient Record *</label>
                        <div class="space-y-2">
                            <template x-for="patient in otp.patientOptions" :key="patient.id">
                                <label class="relative block cursor-pointer">
                                    <input type="radio" 
                                        :value="patient.id" 
                                        x-model="otp.selectedPatientId" 
                                        class="sr-only" 
                                        @change="selectPatient(patient.id)">
                                    <div class="p-4 border rounded-lg transition-all"
                                        :class="otp.selectedPatientId === patient.id ? 'border-primary-600 bg-primary-50 ring-2 ring-primary-600' : 'border-gray-300 hover:border-gray-400'">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h4 class="font-medium text-gray-900" x-text="patient.name"></h4>
                                                <p class="text-sm text-gray-500">
                                                    Registered: <span x-text="patient.registered"></span>
                                                    <template x-if="patient.last_visit">
                                                        <span> â€¢ Last Visit: <span x-text="patient.last_visit"></span></span>
                                                    </template>
                                                </p>
                                            </div>
                                            <div x-show="otp.selectedPatientId === patient.id" class="text-primary-600">
                                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </template>
                        </div>
                        <p x-show="errors.patient_selection" class="mt-2 text-sm text-red-600" x-text="errors.patient_selection"></p>
                    </div>

                    <!-- Success indicator for verified single patient -->
                    <div x-show="otp.verified && !otp.showPatientSelection" class="p-4 bg-green-50 border border-green-200 rounded-md">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-green-700">Patient verified: <strong x-text="otp.verifiedPatientName"></strong></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Patient Form -->
                <div x-show="form.patient_type === 'new'" class="space-y-6">
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                            <input type="text" x-model="form.first_name" 
                                   :class="['w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500', errors.first_name ? 'border-red-300' : 'border-gray-300']"
                                   @input="clearErrors('first_name')">
                            <p x-show="errors.first_name" class="mt-1 text-sm text-red-600" x-text="errors.first_name"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                            <input type="text" x-model="form.last_name" 
                                   :class="['w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500', errors.last_name ? 'border-red-300' : 'border-gray-300']"
                                   @input="clearErrors('last_name')">
                            <p x-show="errors.last_name" class="mt-1 text-sm text-red-600" x-text="errors.last_name"></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                            <input type="email" x-model="form.email" 
                                   :class="['w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500', errors.email ? 'border-red-300' : 'border-gray-300']"
                                   @input="clearErrors('email')">
                            <p x-show="errors.email" class="mt-1 text-sm text-red-600" x-text="errors.email"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label>
                            <input type="tel" x-model="form.contact_number"
                                   :class="['w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500', errors.contact_number ? 'border-red-300' : 'border-gray-300']"
                                   placeholder="+639123456789"
                                   @input="clearErrors('contact_number')">
                            <p class="mt-1 text-sm text-gray-500">Optional: For SMS updates</p>
                            <p x-show="errors.contact_number" class="mt-1 text-sm text-red-600" x-text="errors.contact_number"></p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                        <textarea x-model="form.address" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="px-8 py-4 bg-gray-50 flex justify-end">
                <button type="button" @click="nextStep()" 
                        class="px-6 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500">
                    Next: Service & Schedule
                </button>
            </div>
        </div>

        <!-- Step 2: Service & Date/Period Selection -->
        <div x-show="step === 2">
            <div class="p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Service & Schedule</h2>
                
                <!-- Service Selection -->
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Select Service *</label>
                    <select x-model="form.service" @change="updateServiceInfo(); clearErrors('service')" 
                            :class="['w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500', errors.service ? 'border-red-300' : 'border-gray-300']">
                        <option value="">Choose a service...</option>
                        <template x-for="service in services" :key="service.id">
                            <option :value="service.id" x-text="service.name"></option>
                        </template>
                    </select>
                    <p x-show="errors.service" class="mt-1 text-sm text-red-600" x-text="errors.service"></p>
                    
                    <!-- Service Information -->
                    <div x-show="selectedService" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">Service Details</h4>
                        <div class="text-sm text-blue-700 space-y-1">
                            <p><strong>Price Range:</strong> <span x-text="selectedService?.price_range"></span></p>
                            <p><strong>Description:</strong> <span x-text="selectedService?.description"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Date Selection -->
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Select Date *</label>
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <button type="button" @click="changeMonth(-1)" 
                                    class="p-2 hover:bg-gray-100 rounded-md">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <h4 class="font-medium text-gray-900" x-text="currentMonthName + ' ' + currentYear"></h4>
                            <button type="button" @click="changeMonth(1)" 
                                    class="p-2 hover:bg-gray-100 rounded-md">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 mb-2">
                            <div class="text-center text-xs font-medium text-gray-500 py-2">Mon</div>
                            <div class="text-center text-xs font-medium text-gray-500 py-2">Tue</div>
                            <div class="text-center text-xs font-medium text-gray-500 py-2">Wed</div>
                            <div class="text-center text-xs font-medium text-gray-500 py-2">Thu</div>
                            <div class="text-center text-xs font-medium text-gray-500 py-2">Fri</div>
                            <div class="text-center text-xs font-medium text-gray-500 py-2">Sat</div>
                            <div class="text-center text-xs font-medium text-gray-500 py-2">Sun</div>
                        </div>
                        <div class="grid grid-cols-7 gap-1">
                            <template x-for="day in calendarDays" :key="day.date || day.index">
                                <button type="button" 
                                        class="calendar-day text-sm rounded-md border min-h-[40px] flex items-center justify-center" 
                                        :class="getDateClasses(day)"
                                        @click="day.isEmpty || !day.available ? null : selectDate(day)"
                                        :disabled="day.isEmpty || !day.available"
                                        x-text="day.day">
                                </button>
                            </template>
                        </div>
                    </div>
                    <p x-show="errors.appointment_date" class="mt-2 text-sm text-red-600" x-text="errors.appointment_date"></p>
                </div>

                <!-- Period Selection (AM/PM) -->
                <div x-show="form.appointment_date" class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Select Time Period *</label>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <label class="relative">
                            <input type="radio" x-model="form.period" value="AM" class="sr-only" @change="clearErrors('period')">
                            <div class="p-4 border rounded-lg cursor-pointer transition-all" 
                                 :class="form.period === 'AM' ? 'border-primary-600 bg-primary-50 ring-2 ring-primary-600' : (availableSlots.AM > 0 ? 'border-gray-300 hover:border-gray-400' : 'border-gray-200 bg-gray-50 cursor-not-allowed opacity-50')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900">Morning (AM)</h3>
                                        <p class="text-sm text-gray-500">{{ am_period_display }}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-medium" :class="availableSlots.AM > 0 ? 'text-green-600' : 'text-red-600'">
                                            <span x-text="availableSlots.AM"></span> slots available
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </label>
                        <label class="relative">
                            <input type="radio" x-model="form.period" value="PM" class="sr-only" @change="clearErrors('period')">
                            <div class="p-4 border rounded-lg cursor-pointer transition-all" 
                                 :class="form.period === 'PM' ? 'border-primary-600 bg-primary-50 ring-2 ring-primary-600' : (availableSlots.PM > 0 ? 'border-gray-300 hover:border-gray-400' : 'border-gray-200 bg-gray-50 cursor-not-allowed opacity-50')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900">Afternoon (PM)</h3>
                                        <p class="text-sm text-gray-500">{{ pm_period_display }}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-medium" :class="availableSlots.PM > 0 ? 'text-green-600' : 'text-red-600'">
                                            <span x-text="availableSlots.PM"></span> slots available
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                    <p x-show="errors.period" class="mt-2 text-sm text-red-600" x-text="errors.period"></p>
                </div>

                <!-- Reason (Optional) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Visit</label>
                    <textarea x-model="form.reason" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                              placeholder="Please describe your symptoms or reason for the appointment (optional)"></textarea>
                </div>
            </div>
            
            <div class="px-8 py-4 bg-gray-50 flex justify-between">
                <button type="button" @click="prevStep()" 
                        class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500">
                    Back
                </button>
                <button type="button" @click="nextStep()" 
                        class="px-6 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500">
                    Next: Review & Confirm
                </button>
            </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div x-show="step === 3">
            <div class="p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Review & Confirm</h2>
                
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Appointment Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Patient:</span>
                            <span class="font-medium" x-text="getPatientName()"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Service:</span>
                            <span class="font-medium" x-text="getSelectedServiceName()"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Date:</span>
                            <span class="font-medium" x-text="formatDate(form.appointment_date)"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Period:</span>
                            <span class="font-medium" x-text="form.period === 'AM' ? 'Morning ({{ am_period_display }})' : 'Afternoon ({{ pm_period_display }})'"></span>
                        </div>
                        <div x-show="form.reason" class="flex justify-between">
                            <span class="text-gray-600">Reason:</span>
                            <span class="font-medium" x-text="form.reason"></span>
                        </div>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="mb-6">
                    <label class="flex items-start">
                        <input type="checkbox" x-model="form.agreed_to_terms" 
                               :class="['mt-1 h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded', errors.agreed_to_terms ? 'border-red-300' : '']"
                               @change="clearErrors('agreed_to_terms')">
                        <div class="ml-3 text-sm text-gray-600">
                            I agree to the clinic's terms and conditions. I understand that this is a request and not a confirmed appointment. I will receive confirmation via email or SMS. *
                        </div>
                    </label>
                    <p x-show="errors.agreed_to_terms" class="mt-2 text-sm text-red-600" x-text="errors.agreed_to_terms"></p>
                </div>
            </div>
            
            <div class="px-8 py-4 bg-gray-50 flex justify-between">
                <button type="button" @click="prevStep()" 
                        class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500">
                    Back
                </button>
                <button type="submit" 
                        :disabled="submitting"
                        class="px-6 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!submitting">Submit Request</span>
                    <span x-show="submitting" class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Submitting...
                    </span>
                </button>
            </div>
        </div>
    </form>
</div>

<style>
    .calendar-day.unavailable {
        opacity: 0.3;
        cursor: not-allowed;
    }
    .calendar-day.available:hover {
        background-color: #dbeafe;
    }
    .calendar-day.selected {
        background-color: #3b82f6;
        color: white;
    }
</style>

<script>
    const servicesData = {{ services_json|safe }};
    const csrfToken = '{{ csrf_token }}';
    
    function appointmentBooking() {
        return {
            step: 1,
            submitting: false,
            submitted: false,
            referenceNumber: '',
            errorMessage: '',
            
            errors: {},
            services: servicesData || [],
            
            // OTP state
            otp: {
                email: '',
                code: '',
                codeSent: false,
                verified: false,
                sending: false,
                verifying: false,
                selectingPatient: false,  // NEW - prevent multiple calls
                canResend: true,
                remainingAttempts: null,
                accessCodeId: null,
                patientOptions: [],
                showPatientSelection: false,
                selectedPatientId: null,
                verifiedPatientName: '',
                verifiedPatientData: null
            },
            
            // Form data
            form: {
                patient_type: '',
                patient_id: null,
                first_name: '',
                last_name: '',
                email: '',
                contact_number: '',
                address: '',
                service: '',
                appointment_date: '',
                period: '',
                reason: '',
                agreed_to_terms: false
            },
            
            // Calendar
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            
            selectedService: null,
            calendarDays: [],
            availableSlots: { AM: 0, PM: 0 },
            slotData: {},
            
            init() {
                this.generateCalendar();
                
                this.$watch('form.appointment_date', (value) => {
                    if (value) {
                        this.loadSlotAvailability();
                    }
                });
            },
            
            get currentMonthName() {
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                return months[this.currentMonth];
            },
            
            clearErrors(field = null) {
                if (field) {
                    delete this.errors[field];
                } else {
                    this.errors = {};
                }
                this.errorMessage = '';
            },
            
            handlePatientTypeChange() {
                this.clearErrors();
                // Reset OTP state when switching patient type
                this.otp = {
                    email: '',
                    code: '',
                    codeSent: false,
                    verified: false,
                    sending: false,
                    verifying: false,
                    canResend: true,
                    remainingAttempts: null,
                    accessCodeId: null,
                    patientOptions: [],
                    showPatientSelection: false,
                    selectedPatientId: null,
                    verifiedPatientName: '',
                    verifiedPatientData: null
                };
            },
            
            async sendOTPCode() {
                this.clearErrors('otp_email');
                
                if (!this.otp.email || !this.otp.email.trim()) {
                    this.errors.otp_email = 'Please enter your email address.';
                    return;
                }
                
                this.otp.sending = true;
                
                try {
                    const response = await fetch('/api/booking/send-otp/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({ email: this.otp.email })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.otp.codeSent = true;
                        this.otp.canResend = false;
                        this.otp.remainingAttempts = data.remaining_attempts;
                        this.errorMessage = '';
                        
                        // Enable resend after 60 seconds
                        setTimeout(() => {
                            this.otp.canResend = true;
                        }, 60000);
                        
                    } else {
                        this.errors.otp_email = data.error;
                    }
                } catch (error) {
                    console.error('Error sending OTP:', error);
                    this.errors.otp_email = 'Failed to send verification code. Please try again.';
                } finally {
                    this.otp.sending = false;
                }
            },
            
            async verifyOTPCode() {
                this.clearErrors('otp_code');
                
                if (!this.otp.code || this.otp.code.length !== 6) {
                    this.errors.otp_code = 'Please enter the 6-digit verification code.';
                    return;
                }
                
                this.otp.verifying = true;
                
                try {
                    const response = await fetch('/api/booking/verify-otp/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({ 
                            email: this.otp.email,
                            code: this.otp.code
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.verified) {
                        this.otp.verified = true;
                        this.otp.accessCodeId = data.access_code_id;
                        this.otp.patientOptions = data.patients;
                        this.otp.showPatientSelection = data.multiple_patients;
                        
                        if (!data.multiple_patients && data.patients.length === 1) {
                            // Single patient - auto-select
                            await this.selectPatient(data.patients[0].id);
                        }
                        
                        this.errorMessage = '';
                    } else {
                        this.errors.otp_code = data.error;
                    }
                } catch (error) {
                    console.error('Error verifying OTP:', error);
                    this.errors.otp_code = 'Failed to verify code. Please try again.';
                } finally {
                    this.otp.verifying = false;
                }
            },
            
            async selectPatient(patientId) {
                // Prevent multiple simultaneous calls
                if (this.otp.selectingPatient) {
                    return;
                }
                
                this.otp.selectingPatient = true;
                
                try {
                    const response = await fetch('/api/booking/select-patient/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({ 
                            access_code_id: this.otp.accessCodeId,
                            patient_id: patientId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.otp.verifiedPatientData = data.patient;
                        this.otp.verifiedPatientName = data.patient.name;
                        this.form.patient_id = data.patient.id;
                        this.otp.selectedPatientId = data.patient.id; // Update for visual feedback
                        this.clearErrors('patient_selection');
                        console.log('Patient selected successfully:', data.patient.name);
                    } else {
                        this.errorMessage = data.error;
                        console.error('Error selecting patient:', data.error);
                    }
                } catch (error) {
                    console.error('Error selecting patient:', error);
                    this.errorMessage = 'Failed to select patient. Please try again.';
                } finally {
                    this.otp.selectingPatient = false;
                }
            },
            
            validateStep() {
                this.clearErrors();
                let isValid = true;
                
                switch (this.step) {
                    case 1:
                        if (!this.form.patient_type) {
                            this.errors.patient_type = 'Please select patient type';
                            isValid = false;
                        }
                        
                        if (this.form.patient_type === 'existing') {
                            if (!this.otp.verified) {
                                this.errors.otp_email = 'Please verify your email address';
                                isValid = false;
                            }
                            
                            if (this.otp.showPatientSelection && !this.otp.selectedPatientId) {
                                this.errors.patient_selection = 'Please select your patient record';
                                isValid = false;
                            }
                        } else if (this.form.patient_type === 'new') {
                            const requiredFields = ['first_name', 'last_name', 'email'];
                            for (const field of requiredFields) {
                                if (!this.form[field]?.trim()) {
                                    const label = field.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    this.errors[field] = `${label} is required`;
                                    isValid = false;
                                }
                            }
                            
                            if (this.form.email && !this.isValidEmail(this.form.email)) {
                                this.errors.email = 'Please enter a valid email address';
                                isValid = false;
                            }
                            
                            if (this.form.contact_number && !this.isValidPhoneNumber(this.form.contact_number)) {
                                this.errors.contact_number = 'Please enter a valid Philippine mobile number';
                                isValid = false;
                            }
                        }
                        break;
                        
                    case 2:
                        if (!this.form.service) {
                            this.errors.service = 'Please select a service';
                            isValid = false;
                        }
                        if (!this.form.appointment_date) {
                            this.errors.appointment_date = 'Please select an appointment date';
                            isValid = false;
                        }
                        if (!this.form.period) {
                            this.errors.period = 'Please select a time period (AM or PM)';
                            isValid = false;
                        }
                        
                        if (this.form.period && this.availableSlots[this.form.period] <= 0) {
                            this.errors.period = `No ${this.form.period} slots available for selected date`;
                            isValid = false;
                        }
                        break;
                        
                    case 3:
                        if (!this.form.agreed_to_terms) {
                            this.errors.agreed_to_terms = 'Please agree to the terms and conditions';
                            isValid = false;
                        }
                        break;
                }
                
                return isValid;
            },
            
            nextStep() {
                if (this.validateStep()) {
                    this.step++;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            },
            
            prevStep() {
                this.step--;
                this.clearErrors();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },
            
            updateServiceInfo() {
                if (this.form.service) {
                    this.selectedService = this.services.find(s => s.id == this.form.service);
                } else {
                    this.selectedService = null;
                }
            },
            
            generateCalendar() {
                const firstDay = new Date(this.currentYear, this.currentMonth, 1);
                const firstDayOfWeek = firstDay.getDay();
                const daysToGoBack = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
                
                this.calendarDays = [];
                
                for (let i = 0; i < 42; i++) {
                    const dayOfMonth = 1 - daysToGoBack + i;
                    const currentDate = new Date(this.currentYear, this.currentMonth, dayOfMonth);
                    
                    const dayData = {
                        date: this.formatDateForAPI(currentDate),
                        day: currentDate.getDate(),
                        isEmpty: currentDate.getMonth() !== this.currentMonth,
                        available: false,
                        isToday: this.isToday(currentDate),
                        isSelected: this.form.appointment_date === this.formatDateForAPI(currentDate)
                    };
                    
                    if (this.isDateAvailable(currentDate)) {
                        dayData.available = true;
                    }
                    
                    this.calendarDays.push(dayData);
                }
                
                this.loadMonthSlotAvailability();
            },
            
            changeMonth(direction) {
                this.currentMonth += direction;
                if (this.currentMonth < 0) {
                    this.currentMonth = 11;
                    this.currentYear--;
                } else if (this.currentMonth > 11) {
                    this.currentMonth = 0;
                    this.currentYear++;
                }
                this.generateCalendar();
            },
            
            isToday(date) {
                const today = new Date();
                return date.toDateString() === today.toDateString();
            },
            
            isDateAvailable(date) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const checkDate = new Date(date);
                checkDate.setHours(0, 0, 0, 0);
                
                if (checkDate <= today) {
                    return false;
                }
                
                if (date.getDay() === 0) {
                    return false;
                }
                
                return true;
            },
            
            selectDate(day) {
                if (!day.available || day.isEmpty) {
                    return;
                }
                
                if (day.hasSlots === false || (day.amSlots === 0 && day.pmSlots === 0)) {
                    this.errorMessage = `No appointment slots available for ${this.formatDate(day.date)}`;
                    return;
                }
                
                this.form.appointment_date = day.date;
                this.form.period = '';
                
                this.loadSlotAvailability();
                this.generateCalendar();
            },
            
            getDateClasses(day) {
                let classes = [];
                
                if (day.isEmpty) {
                    classes.push('text-gray-300', 'cursor-not-allowed');
                } else if (!day.available) {
                    classes.push('text-gray-400', 'bg-gray-100', 'cursor-not-allowed', 'unavailable');
                } else {
                    classes.push('text-gray-900', 'hover:bg-blue-100', 'cursor-pointer', 'available');
                    
                    if (day.isSelected) {
                        classes.push('bg-primary-600', 'text-white', 'selected');
                    } else if (day.isToday) {
                        classes.push('bg-blue-50', 'text-blue-600', 'font-semibold');
                    }
                    
                    if (day.hasSlots === false || (day.amSlots === 0 && day.pmSlots === 0)) {
                        classes.push('ring-2', 'ring-red-200');
                    } else if (day.amSlots > 0 || day.pmSlots > 0) {
                        classes.push('ring-2', 'ring-green-200');
                    }
                }
                
                return classes.join(' ');
            },
            
            async loadMonthSlotAvailability() {
                if (!this.currentYear || this.currentMonth < 0) return;
                
                const startDate = new Date(this.currentYear, this.currentMonth, 1);
                const endDate = new Date(this.currentYear, this.currentMonth + 1, 0);
                
                try {
                    const response = await fetch(
                        `/appointments/api/slot-availability/?start_date=${this.formatDateForAPI(startDate)}&end_date=${this.formatDateForAPI(endDate)}`
                    );
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.availability) {
                        this.slotData = data.availability;
                        
                        this.calendarDays = this.calendarDays.map(day => {
                            if (!day.isEmpty && day.available && this.slotData[day.date]) {
                                const daySlots = this.slotData[day.date];
                                const hasSlots = daySlots.am_slots.available > 0 || daySlots.pm_slots.available > 0;
                                
                                return {
                                    ...day,
                                    available: hasSlots,
                                    hasSlots: hasSlots,
                                    amSlots: daySlots.am_slots.available,
                                    pmSlots: daySlots.pm_slots.available
                                };
                            }
                            
                            return day;
                        });
                    }
                } catch (error) {
                    console.error('Error loading month slot availability:', error);
                }
            },
            
            async loadSlotAvailability() {
                if (!this.form.appointment_date) {
                    this.availableSlots = { AM: 0, PM: 0 };
                    return;
                }
                
                if (this.slotData[this.form.appointment_date]) {
                    const dayData = this.slotData[this.form.appointment_date];
                    this.availableSlots = {
                        AM: dayData.am_slots?.available || 0,
                        PM: dayData.pm_slots?.available || 0
                    };
                    return;
                }
                
                try {
                    const nextDate = new Date(this.form.appointment_date);
                    nextDate.setDate(nextDate.getDate() + 1);
                    
                    const response = await fetch(
                        `/appointments/api/slot-availability/?start_date=${this.form.appointment_date}&end_date=${this.formatDateForAPI(nextDate)}`
                    );
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.availability && data.availability[this.form.appointment_date]) {
                        const dayData = data.availability[this.form.appointment_date];
                        this.availableSlots = {
                            AM: dayData.am_slots?.available || 0,
                            PM: dayData.pm_slots?.available || 0
                        };
                        
                        this.slotData[this.form.appointment_date] = dayData;
                    } else {
                        this.availableSlots = { AM: 0, PM: 0 };
                    }
                } catch (error) {
                    console.error('Error loading slot availability:', error);
                    this.availableSlots = { AM: 0, PM: 0 };
                }
            },
            
            async submitForm() {
                if (!this.validateStep()) {
                    return;
                }
                
                this.submitting = true;
                this.clearErrors();
                
                try {
                    // Prepare submission data
                    let submissionData = {
                        service: this.form.service,
                        appointment_date: this.form.appointment_date,
                        period: this.form.period,
                        reason: this.form.reason,
                        agreed_to_terms: this.form.agreed_to_terms
                    };

                    if (this.form.patient_type === 'existing') {
                        submissionData.patient_id = this.form.patient_id;
                        submissionData.patient_type = 'existing';
                    } else {
                        submissionData.patient_type = 'new';
                        submissionData.first_name = this.form.first_name;
                        submissionData.last_name = this.form.last_name;
                        submissionData.email = this.form.email;
                        submissionData.contact_number = this.form.contact_number;
                        submissionData.address = this.form.address;
                    }

                    const response = await fetch('/api/booking/submit/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify(submissionData)
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.submitted = true;
                        this.referenceNumber = data.reference_number;
                        this.errorMessage = '';
                    } else {
                        this.errorMessage = data.error || 'Failed to submit appointment request.';
                    }
                } catch (error) {
                    console.error('Error submitting appointment:', error);
                    this.errorMessage = 'Failed to submit appointment request. Please try again.';
                } finally {
                    this.submitting = false;
                }
            },
            
            getPatientName() {
                if (this.form.patient_type === 'existing' && this.otp.verifiedPatientName) {
                    return this.otp.verifiedPatientName;
                } else if (this.form.patient_type === 'new') {
                    return `${this.form.first_name} ${this.form.last_name}`.trim();
                }
                return '';
            },
            
            getSelectedServiceName() {
                return this.selectedService ? this.selectedService.name : '';
            },
            
            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            },
            
            formatDateForAPI(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
            
            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },
            
            isValidPhoneNumber(phone) {
                const phoneRegex = /^(\+63|0)?9\d{9}$/;
                const cleanPhone = phone.replace(/[\s-]/g, '');
                return phoneRegex.test(cleanPhone);
            }
        };
    }
</script>
{% endblock %}
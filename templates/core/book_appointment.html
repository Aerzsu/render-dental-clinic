{% extends "base_public.html" %}

{% block title %}Book Appointment - KingJoy Dental Clinic{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8" x-data="appointmentBooking()">
    <!-- Header -->
    <div class="text-center mb-8">
        <div class="w-16 h-16 bg-primary-600 rounded-full mx-auto mb-4 flex items-center justify-center">
            <span class="text-white text-2xl">ðŸ¦·</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Book Your Appointment</h1>
        <p class="text-gray-600">Schedule your dental visit in 3 easy steps</p>
    </div>

    <!-- Progress Steps -->
    <div class="max-w-3xl mx-auto mb-8">
        <div class="flex items-center justify-between">
            <!-- Step 1: Service & Schedule -->
            <div class="flex items-center" :class="step >= 1 ? 'text-primary-600' : 'text-gray-400'">
                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center" 
                     :class="step >= 1 ? 'border-primary-600 bg-primary-600 text-white' : 'border-gray-300'">
                    <span class="text-sm font-medium">1</span>
                </div>
                <span class="ml-2 text-sm font-medium hidden sm:inline">Service & Schedule</span>
                <span class="ml-2 text-sm font-medium sm:hidden">Schedule</span>
            </div>
            <div class="flex-1 h-px mx-4" :class="step >= 2 ? 'bg-primary-600' : 'bg-gray-300'"></div>
            
            <!-- Step 2: Patient Info -->
            <div class="flex items-center" :class="step >= 2 ? 'text-primary-600' : 'text-gray-400'">
                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center" 
                     :class="step >= 2 ? 'border-primary-600 bg-primary-600 text-white' : 'border-gray-300'">
                    <span class="text-sm font-medium">2</span>
                </div>
                <span class="ml-2 text-sm font-medium hidden sm:inline">Patient Info</span>
                <span class="ml-2 text-sm font-medium sm:hidden">Info</span>
            </div>
            <div class="flex-1 h-px mx-4" :class="step >= 3 ? 'bg-primary-600' : 'bg-gray-300'"></div>
            
            <!-- Step 3: Confirm -->
            <div class="flex items-center" :class="step >= 3 ? 'text-primary-600' : 'text-gray-400'">
                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center" 
                     :class="step >= 3 ? 'border-primary-600 bg-primary-600 text-white' : 'border-gray-300'">
                    <span class="text-sm font-medium">3</span>
                </div>
                <span class="ml-2 text-sm font-medium hidden sm:inline">Confirm</span>
            </div>
        </div>
    </div>

    <!-- Error Banner -->
    <div x-show="errorMessage" class="max-w-3xl mx-auto mb-6">
        <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded-r-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-sm text-red-700" x-text="errorMessage"></p>
                </div>
                <div class="ml-auto pl-3">
                    <button type="button" @click="errorMessage = ''" class="inline-flex bg-red-50 rounded-md p-1.5 text-red-400 hover:bg-red-100 transition-colors">
                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Important Notice -->
    <div class="max-w-3xl mx-auto mb-6">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        <strong>Important:</strong> This is an appointment request. You will receive confirmation within 24 hours. 
                        Appointments are available Monday to Saturday only. Clinic hours: <strong>{{ clinic_hours }}</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div x-show="submitted" class="max-w-3xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden mb-8">
        <div class="p-8 text-center">
            <!-- Dynamic Icon based on auto-approval -->
            <div class="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center"
                :class="autoApproved ? 'bg-green-100' : 'bg-blue-100'">
                <svg class="w-8 h-8" :class="autoApproved ? 'text-green-600' : 'text-blue-600'" 
                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            
            <!-- Dynamic Heading -->
            <h2 class="text-2xl font-bold text-gray-900 mb-2" 
                x-text="autoApproved ? 'Appointment Confirmed!' : 'Request Submitted!'">
            </h2>
            
            <!-- Dynamic Description -->
            <template x-if="autoApproved">
                <p class="text-gray-600 mb-6">
                    Great news! Your appointment has been automatically confirmed. 
                    You will receive a confirmation email shortly with all the details.
                </p>
            </template>
            
            <template x-if="!autoApproved">
                <p class="text-gray-600 mb-6">
                    Your appointment request has been received. We'll review it and contact you within 24 hours to confirm.
                </p>
            </template>
            
            <!-- Reference Details -->
            <div class="border rounded-lg p-4 mb-6"
                :class="autoApproved ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200'">
                <p class="text-sm text-left space-y-1"
                :class="autoApproved ? 'text-green-700' : 'text-blue-700'">
                    <strong>Reference Number:</strong> <span x-text="referenceNumber"></span><br>
                    <strong>Status:</strong> <span x-text="autoApproved ? 'Confirmed âœ“' : 'Pending Review'"></span><br>
                    <strong>Service:</strong> <span x-text="getSelectedServiceName()"></span><br>
                    <strong>Date:</strong> <span x-text="formatDate(form.appointment_date)"></span><br>
                    <strong>Time:</strong> <span x-text="form.start_time"></span><br>
                    <span class="text-xs mt-2 block">Please keep this reference number for your records.</span>
                </p>
            </div>

            <!-- What Happens Next - Dynamic based on auto-approval -->
            <div class="space-y-3 mb-6 text-left">
                
                <!-- Auto-Approved Flow -->
                <template x-if="autoApproved">
                    <div>
                        <div class="flex items-start mb-3">
                            <svg class="w-5 h-5 text-green-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <div>
                                <p class="font-medium text-gray-900">Your appointment is confirmed!</p>
                                <p class="text-sm text-gray-600 mt-1">No further action needed. We look forward to seeing you at your scheduled time.</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start mb-3">
                            <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                            </svg>
                            <div>
                                <p class="font-medium text-gray-900">Check your email</p>
                                <p class="text-sm text-gray-600 mt-1">
                                    A confirmation email has been sent to <strong x-text="form.patient_type === 'existing' ? otp.email : form.email"></strong>.
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-purple-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                            </svg>
                            <div>
                                <p class="font-medium text-gray-900">Add to calendar</p>
                                <p class="text-sm text-gray-600 mt-1">Save the date and arrive 10 minutes early for check-in.</p>
                            </div>
                        </div>
                    </div>
                </template>
                
                <!-- Pending Approval Flow -->
                <template x-if="!autoApproved">
                    <div>
                        <div class="flex items-start mb-3">
                            <svg class="w-5 h-5 text-green-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <div>
                                <p class="font-medium text-gray-900">What happens next?</p>
                                <p class="text-sm text-gray-600 mt-1">We'll review your request and send a confirmation email with your exact appointment time.</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start mb-3">
                            <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                            </svg>
                            <div>
                                <p class="font-medium text-gray-900">Check your email</p>
                                <p class="text-sm text-gray-600 mt-1">
                                    Check <strong x-text="form.patient_type === 'existing' ? otp.email : form.email"></strong> for our confirmation.
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-purple-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <div>
                                <p class="font-medium text-gray-900">No confirmation yet?</p>
                                <p class="text-sm text-gray-600 mt-1">Contact us directly if you don't hear back within 24 hours.</p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <a href="{% url 'patient_portal:login' %}" 
                class="inline-block px-6 py-3 text-white rounded-lg transition-colors"
                :class="autoApproved ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'">
                    View in Patient Portal
                </a>
                <a href="{% url 'core:home' %}" 
                class="inline-block px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    Return to Home
                </a>
            </div>
        </div>
    </div>

    <!-- Booking Form -->
    <form x-show="!submitted" class="max-w-3xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden" @submit.prevent="submitForm">
        
        <!-- Step 2: Patient Information -->
        {% include 'core/partials/_step2_patient_info.html' %}

        <!-- Step 1: Service & Schedule Selection -->
        {% include 'core/partials/_step1_service_schedule.html' %}

        <!-- Step 3: Review & Confirm -->
        {% include 'core/partials/_step3_confirm.html' %}

    </form>

    <!-- Payment Terms Notice -->
    <div class="max-w-3xl mx-auto mt-8 mb-6">
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8a1 1 0 012 0v3a1 1 0 01-2 0V10zm1-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-base font-semibold text-blue-700 mb-2">Payment</h3>
                    <p class="text-sm text-blue-700 mb-2">
                        At KingJoy Dental Clinic, we currently accept <strong>cash payments only</strong> for all dental services. 
                        This helps us keep our operations simple and provide affordable, transparent pricing.
                    </p>
                    <p class="text-sm text-blue-700 mb-2">
                        <strong>Please note:</strong> We do not accept credit/debit cards, GCash, Maya, or HMO/health cards.
                    </p>
                    <p class="text-sm text-blue-700">
                        For payment inquiries, contact KingJoy Dental Clinicâ€”we're happy to assist!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Terms Modal -->
    {% include 'core/partials/_booking_terms_modal.html' %}
</div>

<!-- JavaScript -->
{% include 'core/partials/_booking_script.html' %}

<style>
/* Timeslot button styles */
.timeslot-btn {
    transition: all 0.2s ease;
}

.timeslot-btn:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.timeslot-btn.selected {
    background-color: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.timeslot-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Calendar day styles */
.calendar-day {
    transition: all 0.15s ease;
}

.calendar-day.available:hover {
    background-color: #dbeafe;
    transform: scale(1.05);
}

.calendar-day.selected {
    background-color: #3b82f6;
    color: white;
}

.calendar-day.unavailable {
    opacity: 0.3;
    cursor: not-allowed;
}

.calendar-day.has-slots {
    position: relative;
}

.calendar-day.has-slots::after {
    content: '';
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background-color: #10b981;
    border-radius: 50%;
}

.calendar-day.all-slots-taken::after {
    background-color: #ef4444;
}

/* Loading animation */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
</style>

{% endblock %}